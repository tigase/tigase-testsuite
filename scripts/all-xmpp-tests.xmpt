-version = "2.0.0"

-output-format  = html
-output-file    = "../www/functional-tests.html"
-output-history = yes
-history-format = separate-file
-output-cols    = 7
-title          = "XMPP Server functional tests."

$(server-host) = test-d
$(def-user)    = all-xmpp-test
$(daemon-user) = all-xmpp-test_1
$(blocking-user) = blocking-test-user_1
$(long-list-user) = long-list-user_1
$(ssl-tls-wait) = 5000
$(stats-user) = admin
$(stats-pass) = stats

-serverip    = "127.0.0.1"
-host        = $(server-host)
-user-name   = $(def-user)
-user-pass   = all-xmpp-test-password
-socket-wait = 5000
-base-ns     = "jabber:client"
-def-auth    = auth-plain
-keys-file-password   = keystore
-trusts-file-password = truststore
-keys-file            = "certs/keystore"
-trusts-file          = "certs/client_truststore"

-debug-on-error

# Init 0@user-register: {
# -user-name=$(stats-user) -user-pass=$(stats-pass) -no-record
# } >> XEP-0077 - In-Band Registration, register <<
Version@auth-sasl;iq-version: { -user-name=$(stats-user) -user-pass=$(stats-pass) }
 >> Get server version <<
Configuration@command-get-config:
{ -user-name=$(stats-user) -user-pass=$(stats-pass) }
>> Server configuration <<
Statistics@iq-stats: { -user-name=$(stats-user) -user-pass=$(stats-pass) }
 >> Server statistics <<

Global settings:
{
  -loop = 1

  Test 1@socket: >> Plain socket connect. <<
  Test 2@stream-open: >> Stream open to server. <<
  Test 3@ssl-init: { -port = 5223 -socket-wait = $(ssl-tls-wait) }
  >> SSL socket connect. <<
  Test 4@user-register: >> XEP-0077 - In-Band Registration, register <<

  Test 5@auth-plain: >> XEP-0078 Non-SASL authorization with plain password. <<
  Test 6@auth-digest: >> XEP-0078 Non-SASL authorization with digest password. <<

  Test 7@tls-init: { -socket-wait = $(ssl-tls-wait) } >> TLS connection open <<
  Test 8@auth-sasl: { -socket-wait = $(ssl-tls-wait) } >> SASL authorization <<
  Test 9@xmpp-bind: { -socket-wait = $(ssl-tls-wait) } >> XMPP resource bind <<
  Test 10@xmpp-session: { -socket-wait = $(ssl-tls-wait) } >> Establish XMPP session <<
  Test 11@msg-send: { -to-jid = $(self) }
  >> Send a message to self user and don't wait for response <<

  Prep 2@user-register: {
    -no-record
    -user-name = $(daemon-user)
  } >> Create a daemon user account <<

  Prep 3@msg-listen: {
    -no-record
    -daemon

    -socket-wait = 0
    -user-name   = $(daemon-user)
    -delay       = 500
  } >> Setup a user daemon wating for messages <<

  Test 12@msg-send: Send a message to $(daemon-user) user
  { -to-jid = "$(daemon-user)@$(server-host)/xmpp-test" }
  >> Send a message to $(daemon-user)@$(server-host)/xmpp-test user
  and wait for message response <<

  Test 13@iq-version: >> XEP-0092 - get entity version <<
  Test 14@iq-stats: XEP-0039 Statistics Gathering
  { -user-name=$(stats-user) -user-pass=$(stats-pass) }
  >> XEP-0039 Statistics Gathering. <<

  Test 15@roster: >> Roster management test <<

  Test 16@privacy-lists: >> Privacy lists management test <<

  Prep 5@user-register: {
    -no-record
    -user-name = $(blocking-user)
  } >> Create a daemon user account blocking all messages <<

  Prep 6@privacy-block-msg;msg-listen: {
    -no-record
    -daemon

    -socket-wait = 0
    -user-name   = $(blocking-user)
    -delay       = 500
  } >> Setup a user daemon blocking all messages <<

  Test 17@msg-send: Privacy lists - send a message to $(blocking-user) user
  {
    -to-jid = "$(blocking-user)@$(server-host)/xmpp-test"
    -socket-wait = 1000
    -time-out-ok
  } >> Privacy lists test - send a message to $(blocking-user) user blocking all messages and wait for error response <<

  Prep 8@user-register: {
    -no-record
    -user-name = $(long-list-user)
  } >> Create a daemon user account with very long privacy list <<

  Prep 9@privacy-long-list;msg-listen: {
    -no-record
    -daemon

    -socket-wait = 0
    -user-name   = $(long-list-user)
    -delay       = 10000
  } >> Setup a user daemon with very long privacy list <<

  Test 18@msg-send: Send a message to $(long-list-user) user
  {
    -to-jid = "$(long-list-user)@$(server-host)/xmpp-test"
  } >> Send a message to $(long-list-user)@$(server-host)/xmpp-test user
  with very long privacy list and wait for message response <<

  Test 19@common: { -source-file = "tests/data/JabberIqPrivate.cot" }
  >> XEP-0049: Private XML Storage <<

  Test 20@common: { -source-file = "tests/data/FeatureNotImplemented.cot" }
  >> Test for feature-not-implemented error which should be returned when client sends unsupported stanza <<

  Test end@user-unregister:
  >> XEP-0077 - In-Band Registration - user unregister <<

}
>> Script with functional tests for all basic XMPP/Jabber features <<

Multi thread tests:
{

  Multi 1: {
    -multi-thread
    -loop = 5

    Version@iq-version: >> Get server version <<
    Version@iq-version: >> Get server version <<
    Version@iq-version: >> Get server version <<
    Version@iq-version: >> Get server version <<
    Version@iq-version: >> Get server version <<
  } >> Multi-thread test of server Version info <<

  Multi 2: {
    -multi-thread
    -loop = 5

    Register@user-register: { -user-name = "multi-reg_1_$(loop)" }
    >> XEP-0077 <<
    Register@user-register: { -user-name = "multi-reg_2_$(loop)" }
    >> XEP-0077 <<
    Register@user-register: { -user-name = "multi-reg_3_$(loop)" }
    >> XEP-0077 <<
    Register@user-register: { -user-name = "multi-reg_4_$(loop)" }
    >> XEP-0077 <<
    Register@user-register: { -user-name = "multi-reg_5_$(loop)" }
    >> XEP-0077 <<
  } >> Multi-thread test of XEP-0077 - In-Band Registration, user register <<

  Multi 3: {
    -multi-thread
    -loop = 5

    Statistics@iq-stats: { -user-name = "multi-reg_1_$(loop)" }
    >> Server statistics <<
    Statistics@iq-stats: { -user-name = "multi-reg_2_$(loop)" }
    >> Server statistics <<
    Statistics@iq-stats: { -user-name = "multi-reg_3_$(loop)" }
    >> Server statistics <<
    Statistics@iq-stats: { -user-name = "multi-reg_4_$(loop)" }
    >> Server statistics <<
    Statistics@iq-stats: { -user-name = "multi-reg_5_$(loop)" }
    >> Server statistics <<
  } >> Multi-thread test of server Statistics info <<

  Multi 4: {
    -multi-thread
    -loop = 5

    Roster@roster: { -user-name = "multi-reg_1_$(loop)" }
    >> Roster management test <<
    Roster@roster: { -user-name = "multi-reg_2_$(loop)" }
    >> Roster management test <<
    Roster@roster: { -user-name = "multi-reg_3_$(loop)" }
    >> Roster management test <<
    Roster@roster: { -user-name = "multi-reg_4_$(loop)" }
    >> Roster management test <<
    Roster@roster: { -user-name = "multi-reg_5_$(loop)" }
    >> Roster management test <<
  } >> Multi-thread test Roster management functions <<

  Multi 5: {
    -multi-thread
    -loop   = 5
    -to-jid = "$(daemon-user)@$(server-host)/xmpp-test"

    Message send@msg-send: { -user-name = "multi-reg_1_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_2_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_3_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_4_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_5_$(loop)" }
    >> Send a message to daemon user <<
  } >> Multi-thread test of message send to daemon user <<

  Multi 6: {
    -multi-thread
    -loop = 5

    Roster@privacy-lists: { -user-name = "multi-reg_1_$(loop)" }
    >> Privacy lists management test <<
    Roster@privacy-lists: { -user-name = "multi-reg_2_$(loop)" }
    >> Privacy lists management test <<
    Roster@privacy-lists: { -user-name = "multi-reg_3_$(loop)" }
    >> Privacy lists management test <<
    Roster@privacy-lists: { -user-name = "multi-reg_4_$(loop)" }
    >> Privacy lists management test <<
    Roster@privacy-lists: { -user-name = "multi-reg_5_$(loop)" }
    >> Privacy lists management test <<
  } >> Multi-thread test privacy lists management <<

  Multi 7: {
    -multi-thread
    -loop   = 5
    -to-jid = "$(blocking-user)@$(server-host)/xmpp-test"
    -socket-wait = 1000
    -time-out-ok

    Message send@msg-send: { -user-name = "multi-reg_1_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_2_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_3_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_4_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_5_$(loop)" }
    >> Send a message to daemon user <<
  } >> Multi-thread test privacy lists - send a message to daemon user who blocks all messages <<

  Multi 8: {
    -multi-thread
    -loop   = 5
    -to-jid = "$(long-list-user)@$(server-host)/xmpp-test"

    Message send@msg-send: { -user-name = "multi-reg_1_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_2_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_3_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_4_$(loop)" }
    >> Send a message to daemon user <<
    Message send@msg-send: { -user-name = "multi-reg_5_$(loop)" }
    >> Send a message to daemon user <<
  } >> Multi-thread test privacy lists - send a message to daemon user with very long privacy list <<

  Multi-test end: {
    -multi-thread
    -loop = 5

    Register@user-unregister: { -user-name = "multi-reg_1_$(loop)" }
    !! Remove user@user-unregister: { -loop = 1 } >> XEP-0077 <<
    Register@user-unregister: { -user-name = "multi-reg_2_$(loop)" }
    !! Remove user@user-unregister: { -loop = 1 } >> XEP-0077 <<
    Register@user-unregister: { -user-name = "multi-reg_3_$(loop)" }
    !! Remove user@user-unregister: { -loop = 1 } >> XEP-0077 <<
    Register@user-unregister: { -user-name = "multi-reg_4_$(loop)" }
    !! Remove user@user-unregister: { -loop = 1 } >> XEP-0077 <<
    Register@user-unregister: { -user-name = "multi-reg_5_$(loop)" }
    !! Remove user@user-unregister: { -loop = 1 } >> XEP-0077 <<
  } >> Multi-thread test of XEP-0077 - In-Band Registration, user unregister <<

} >> Multi-threaded tests for various XMPP functions <<
